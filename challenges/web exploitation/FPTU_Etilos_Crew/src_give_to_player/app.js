const express = require('express');
const app = express();
const sqlite3 = require('sqlite3');
const uuid = require('uuid');
const fs = require('fs');

const flag = fs.readFileSync('./flag.txt', { encoding: 'utf8' }).trim();

app.use(express.urlencoded({ extended: true }));

const db = new sqlite3.Database(':memory:');

db.serialize(() => {
    db.run('CREATE TABLE API (id INTEGER PRIMARY KEY, joke TEXT)');

    const stmt = db.prepare('INSERT INTO API (id, joke) VALUES (?, ?)');
    const dataToInsert = [
    { id: 1, joke: "What did the bartender say to the jumper cables? You better not try to start anything."},
    { id: 2, joke:"Why did the chicken cross the playground? To get to the other slide." },
    {id: 3, joke:"My girlfriend told me i have EHCTF{Congratulation_u_r_the_b} before leaving me because I keep pretending to be a Transformer... I said, No, wait! I can change!"},
    {id: 4, joke:"Old Chinese proverb: Man who not shower in 7 days makes one reek."},
    {id: 5, joke:"Bee jokes, courtesy of my niece (age 8). What did the bee use to dry off after swimming? A *bee*ch towel. What did the bee use to get out the tangles? A honeycomb."},
    {id: 6, joke:"I went for a job interview today... The interviewer said to me, What would you say your greatest weakness is? I said, I think Id have to say my listening skills are my greatest strength."}
  ];
  
  dataToInsert.forEach((data) => {
    stmt.run(data.id, data.joke);
  });
  
  stmt.finalize();


    const flagTable = `flag_${uuid.v4().replace(/-/g, '_')}`;
    db.run(`CREATE TABLE IF NOT EXISTS ${flagTable} (flag TEXT)`);

    db.run(`INSERT INTO ${flagTable} (flag) VALUES ('${flag}')`);
});


app.get('/', (req, res) => {
    res.sendFile(__dirname + '/index.html');
});

app.get('/search', (req, res) => {
    const { name } = req.query;
    const Filterduidui = /(union|or|substring|substrs|if|case|=|when|then|join|load_extension|likely|unhex|\|\|)/i;

    if (!name) {
        return res.redirect('/search?name=1');
    }

    if (Filterduidui.test(name)) {
        return res.status(400).send({ err: 'chuc mung ban da giai duoc challenge nay' });
    }

    if (!name) {
        return res.status(400).send({ err: 'Try with name param' });
    }

    if (name.length > 6) {
        return res.status(400).send({ err: 'U r hacker?' });
    }

    db.all(`SELECT * FROM API WHERE id LIKE '%${name}%'`, (err, rows) => {
        if (err) {  
            console.error(err.message);
            return res.status(500).send('Hey, what r u doing??? i will call police or don\'t hack this machine');
        }

        return res.send(rows);
    });
});

app.listen(5000, () => {
    console.log('Server is running on port 5008');
});
